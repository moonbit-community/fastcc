{"id":"tinyccmbt-1","title":"Rewrite tinycc in MoonBit","description":"Rewrite tinycc in MoonBit; arm64 backend only; target macOS Mach-O; compiler-only (emit .o).\n\nAll work (including future sub-issues) must stay as close as possible to refs/tinycc.","notes":"All major epic work closed: lexer/preprocessor (tinyccmbt-2), parser/types/sem (tinyccmbt-3), arm64 Mach-O codegen (tinyccmbt-4), and CLI/build integration (tinyccmbt-6). The tool compiles C inputs to arm64 Mach-O .o on macOS (no linker), staying close to refs/tinycc.","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-01-09T14:43:50.187219+08:00","created_by":"agent","updated_at":"2026-01-13T21:11:26.264091+08:00","closed_at":"2026-01-13T21:11:26.264091+08:00","close_reason":"Closed"}
{"id":"tinyccmbt-1.1","title":"Parser/sem: remaining expressions and declarators","description":"Finish remaining C parser/sem features: comma-separated declarators, casts/sizeof, postfix ++/--, member/array initializers, bitfields/qualifiers, and enum constant evaluation, following refs/tinycc/tccgen.c.\\n\\nImplementation must stay as close as possible to refs/tinycc.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T02:44:39.607381+08:00","created_by":"agent","updated_at":"2026-01-10T03:40:04.938625+08:00","closed_at":"2026-01-10T03:40:04.938626+08:00","dependencies":[{"issue_id":"tinyccmbt-1.1","depends_on_id":"tinyccmbt-1","type":"parent-child","created_at":"2026-01-10T02:44:39.608242+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-1.2","title":"Preprocessor: built-in macros and extra directives","description":"Implement preprocessor built-ins (e.g., __LINE__, __FILE__, __DATE__/__TIME__ as in refs/tinycc/tccpp.c) and remaining directives (#line/#error/#warning/#pragma, include_next if applicable). Keep behavior close to refs/tinycc.","notes":"Added built-in macro expansion for __LINE__/__FILE__/__DATE__/__TIME__, #line handling with logical path/line adjustment, #error/#warning/#pragma handling, and include_next support; added preproc tests for builtins and #line.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T03:21:07.63978+08:00","created_by":"agent","updated_at":"2026-01-12T03:13:15.840379+08:00","closed_at":"2026-01-12T03:13:15.84038+08:00","dependencies":[{"issue_id":"tinyccmbt-1.2","depends_on_id":"tinyccmbt-1","type":"parent-child","created_at":"2026-01-11T03:21:07.640388+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-17o","title":"Port mbtcc C tests and make them pass","description":"Import mbtcc's C file test suites (ctest/ctest2) and drive tinycc.mbt toward passing them, keeping behavior as close as possible to refs/tinycc.\\n\\nDefinition of done:\\n- scripts/run_mbtcc_ctest.sh passes (MODE=strict)\\n- scripts/run_mbtcc_ctest2.sh passes (MODE=strict)\\n- Any remaining discrepancies are tracked as sub-issues with refs/tinycc-aligned acceptance criteria.","notes":"Added mbtcc as submodule at refs/mbtcc and runners:\n- scripts/run_mbtcc_ctest.sh\n- scripts/run_mbtcc_ctest2.sh\n\nBaseline (before fixes):\n- ctest: total=52 failed=51\n- ctest2: total=65 failed=65\n\nProgress snapshots:\n- After Darwin varargs fix for printf stack ABI: ctest failed=46, ctest2 failed=62\n- After typedef struct ref-type fix + inc/dec + compound-assign (int): ctest failed=44 (passed=8), ctest2 failed=58 (passed=7)\n- After short-circuit \u0026\u0026/||: ctest2 failed=54 (passed=11)\n- After integer literal parsing fix: ctest2 failed=53 (passed=12)\n- After callee-saved temp regs + ctest support link fix + pointer inc/dec + large member offsets: ctest failed=12, ctest2 failed=21\n- After array-size expressions + VLA stack alloc (arm64): ctest failed=0, ctest2 failed=0 (patched=4; skipped=0; see tinyccmbt-17o.3; local regression goto_vla.c lives under tests/mbtcc/ctest2_patches)\n\nNote: a few ctest2 programs were invalid or depended on UB under gcc baseline; runner applies minimal patches under tests/mbtcc/ctest2_patches (tinyccmbt-17o.3).\n\nNext blockers for compiling larger codebases are tracked under tinyccmbt-2k9.*.","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-01-13T21:22:25.357029+08:00","created_by":"agent","updated_at":"2026-01-14T09:11:39.528016+08:00","closed_at":"2026-01-14T07:06:46.390901+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-17o","depends_on_id":"tinyccmbt-2k9.1","type":"blocks","created_at":"2026-01-13T21:52:50.26183+08:00","created_by":"agent"},{"issue_id":"tinyccmbt-17o","depends_on_id":"tinyccmbt-2k9.2","type":"blocks","created_at":"2026-01-13T21:52:50.328708+08:00","created_by":"agent"},{"issue_id":"tinyccmbt-17o","depends_on_id":"tinyccmbt-2k9.3","type":"blocks","created_at":"2026-01-13T21:52:50.396097+08:00","created_by":"agent"},{"issue_id":"tinyccmbt-17o","depends_on_id":"tinyccmbt-2k9.4","type":"blocks","created_at":"2026-01-13T21:52:50.461686+08:00","created_by":"agent"},{"issue_id":"tinyccmbt-17o","depends_on_id":"tinyccmbt-2k9.5","type":"blocks","created_at":"2026-01-13T21:52:50.528032+08:00","created_by":"agent"},{"issue_id":"tinyccmbt-17o","depends_on_id":"tinyccmbt-2k9.6","type":"blocks","created_at":"2026-01-13T21:52:50.593823+08:00","created_by":"agent"},{"issue_id":"tinyccmbt-17o","depends_on_id":"tinyccmbt-2k9.7","type":"blocks","created_at":"2026-01-14T04:19:07.287958+08:00","created_by":"agent"},{"issue_id":"tinyccmbt-17o","depends_on_id":"tinyccmbt-2k9.8","type":"blocks","created_at":"2026-01-14T04:19:07.414549+08:00","created_by":"agent"},{"issue_id":"tinyccmbt-17o","depends_on_id":"tinyccmbt-2k9.9","type":"blocks","created_at":"2026-01-14T04:19:07.540001+08:00","created_by":"agent"},{"issue_id":"tinyccmbt-17o","depends_on_id":"tinyccmbt-2k9.10","type":"blocks","created_at":"2026-01-14T04:19:07.667441+08:00","created_by":"agent"},{"issue_id":"tinyccmbt-17o","depends_on_id":"tinyccmbt-2k9.11","type":"blocks","created_at":"2026-01-14T04:19:07.793121+08:00","created_by":"agent"},{"issue_id":"tinyccmbt-17o","depends_on_id":"tinyccmbt-2k9.12","type":"blocks","created_at":"2026-01-14T04:19:07.9188+08:00","created_by":"agent"},{"issue_id":"tinyccmbt-17o","depends_on_id":"tinyccmbt-17o.3","type":"blocks","created_at":"2026-01-14T04:19:08.04476+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-17o.1","title":"Add mbtcc ctest/ctest2 runners","description":"Add mbtcc as a git submodule under refs/mbtcc and provide bash-compatible runners that compile each C test with gcc for expected output, then compile with tinycc.mbt to .o, link with clang, run, and compare stdout.","acceptance_criteria":"- refs/mbtcc submodule present\n- scripts/run_mbtcc_ctest.sh works on macOS bash 3.2 (no mapfile)\n- scripts/run_mbtcc_ctest2.sh works on macOS bash 3.2\n- Both scripts support FILTER and MODE=allow-fail","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T21:42:33.619046+08:00","created_by":"agent","updated_at":"2026-01-13T21:44:52.484671+08:00","closed_at":"2026-01-13T21:44:52.484671+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-17o.1","depends_on_id":"tinyccmbt-17o","type":"parent-child","created_at":"2026-01-13T21:42:33.684581+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-17o.2","title":"Baseline mbtcc ctests run + record failures","description":"Run the imported mbtcc ctest/ctest2 suites against current tinycc.mbt and record a baseline pass/fail count + key failure categories; file follow-up issues for compiler feature gaps.","acceptance_criteria":"- Baseline counts recorded in tinyccmbt-17o notes\n- Follow-up issues created for major failure categories","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T21:42:33.765024+08:00","created_by":"agent","updated_at":"2026-01-13T21:44:52.485458+08:00","closed_at":"2026-01-13T21:44:52.485458+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-17o.2","depends_on_id":"tinyccmbt-17o","type":"parent-child","created_at":"2026-01-13T21:42:33.829563+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-17o.3","title":"Runner: handle gcc-broken mbtcc tests (xfail/skip or patch)","description":"Some imported mbtcc tests are not comparable against the runner's gcc baseline (clang) due to invalid code or undefined behavior (UB):\\n- ctest2/complex_function3.c fails to compile under gcc baseline (invalid assignment to function type)\\n- ctest2/dsa_graph_prim.c crashes under gcc baseline due to UB (uninitialized min_index)\\n- ctest2/dsa_dp_edit_distance.c prints uninitialized dp[][] cells; gcc baseline happens to print zeros, but refs/tinycc prints non-zero leftovers (matches tinycc.mbt)\\n\\nHandling must first align with refs/tinycc: if refs/tinycc also fails/mismatches gcc due to UB, mark the test as skip/xfail in scripts; if refs/tinycc passes deterministically, minimally patch the test to remove UB while preserving intent.","acceptance_criteria":"- scripts/run_mbtcc_ctest2.sh MODE=strict passes (with explicit skips/patches for gcc-broken tests)","notes":"Replaced the ctest2 skip list with a patch mechanism:\n- scripts/run_mbtcc_ctest2.sh uses tests/mbtcc/ctest2_patches/\u003cbase\u003e.c when present (and passes -I refs/mbtcc/ctest2 to gcc).\n- Added patches:\n  - complex_function3: remove invalid compose_map implementation (it was unused).\n  - dsa_graph_prim: initialize min_index/parent[] so disconnected graph case is deterministic (no UB/crash).\n  - dsa_dp_edit_distance: initialize dp[][] so intermediate prints are deterministic (no UB).\n\nResult: scripts/run_mbtcc_ctest2.sh MODE=strict passes with total=65 failed=0 (no skips).","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-14T04:14:49.493384+08:00","created_by":"agent","updated_at":"2026-01-14T08:47:18.999095+08:00","closed_at":"2026-01-14T07:06:21.539735+08:00","close_reason":"Closed"}
{"id":"tinyccmbt-1d4","title":"Fix warnings","notes":"Deprecated conversion warnings cleared; moon check now passes with 34 warnings (unused upstream helpers/structs + one unreachable diag add_error). Native build + ctest/ctest2 pass using compiled tinycc.exe.","status":"in_progress","priority":2,"issue_type":"epic","owner":"hackwaly@qq.com","created_at":"2026-01-14T12:10:29.146396+08:00","created_by":"Wen Yuxiang","updated_at":"2026-01-14T13:30:38.679065+08:00"}
{"id":"tinyccmbt-2","title":"MoonBit lexer+preprocessor","description":"Implement tokenization and C preprocessor (macros, includes, conditional compilation) in MoonBit, based on refs/tinycc/tccpp.c and tcctok.h.\n\nImplementation must stay as close as possible to refs/tinycc.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T15:34:08.895799+08:00","created_by":"agent","updated_at":"2026-01-11T03:21:23.03184+08:00","closed_at":"2026-01-11T03:21:23.03184+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-2","depends_on_id":"tinyccmbt-1","type":"parent-child","created_at":"2026-01-10T01:45:51.887153+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-2k9","title":"Make tinycc.mbt can compile refs/tinycc correctly","notes":"ctest/ctest2 now run via built native tinycc executable (_build/native/release/build/tinycc.exe) with both suites passing MODE=strict. Scripts run_mbtcc_ctest*.sh build the exe once (moon build --target native --release) and invoke it instead of moon run.","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-01-13T21:15:01.734089+08:00","created_by":"agent","updated_at":"2026-01-14T12:46:14.867567+08:00","closed_at":"2026-01-14T12:46:14.867569+08:00"}
{"id":"tinyccmbt-2k9.1","title":"Codegen: fix locals/return/stack correctness (mbtcc ctests)","description":"mbtcc ctest/ctest2 show widespread wrong integer values (e.g., ret42.c prints a garbage int; basic_int_arith1 shows a correct b but garbage a and derived ops) and at least one runtime crash (basic_function1 bus error). Fix core codegen correctness for locals, loads/stores, function prolog/epilog, and return value (arm64). Keep behavior close to refs/tinycc's arm64-gen.c + tccgen.c.","acceptance_criteria":"- ret42.c outputs 42 under scripts/run_mbtcc_ctest.sh\n- basic_int_arith1.c outputs match gcc under scripts/run_mbtcc_ctest2.sh\n- basic_function1.c runs without crashing","notes":"Fix: implement Darwin AArch64 varargs call ABI for known varargs functions (e.g. printf).\\n\\nObservation: clang on macOS passes unnamed varargs on the stack (8-byte slots), not in x1..; our previous register-passing caused printf to read garbage / crash.\\n\\nChange: src/codegen_arm64_ast.mbt gen_call_direct now detects varargs calls via SemContext FuncSig and spills varargs args to a temporary outgoing stack area (16-byte aligned), then passes fixed args in x0.. and restores sp after call. Also fixed compute_frame_size to pop its temporary sem scope.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T21:43:59.743654+08:00","created_by":"agent","updated_at":"2026-01-13T22:24:21.902685+08:00","closed_at":"2026-01-13T22:24:21.902685+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-2k9.1","depends_on_id":"tinyccmbt-2k9","type":"parent-child","created_at":"2026-01-13T21:43:59.811549+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-2k9.10","title":"Codegen: aggregate copy (struct/union assignment + init from aggregate expr)","description":"mbtcc tests require aggregate copies like:\\n- struct assignment: rect.top_left = p1;\\n- init from aggregate expr: struct Point p2 = p1;\\n- init from member aggregate: struct Position p = rect.pos;\\n\\nImplement struct/union assignment and initializer-from-aggregate-expression by emitting memcpy-like copies (or ABI-correct register moves for small aggregates), aligning first with refs/tinycc behavior (tccgen.c vstore/indir + struct copy rules).","acceptance_criteria":"- scripts/run_mbtcc_ctest2.sh FILTER='basic_type1' MODE=strict passes\\n- scripts/run_mbtcc_ctest.sh FILTER='struct3' MODE=strict passes","notes":"mbtcc ctest/ctest2 now pass MODE=strict for aggregate-copy cases (struct3.c, basic_type1.c, etc). Aggregate init/assignment lowering aligns with refs/tinycc behavior as exercised by the suite.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-14T04:13:46.994702+08:00","created_by":"agent","updated_at":"2026-01-14T07:12:30.391243+08:00","closed_at":"2026-01-14T07:12:30.391243+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-2k9.10","depends_on_id":"tinyccmbt-2k9","type":"parent-child","created_at":"2026-01-14T04:13:46.995348+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-2k9.11","title":"Codegen/ABI: struct by-value params and returns (AArch64)","description":"mbtcc tests pass structs by value and return structs (e.g. add_complex(struct Complex a, struct Complex b) -\u003e struct Complex; basic_function3.c/4.c). Current call/return path assumes scalar x0 return and scalar params in x0..x7.\\n\\nImplement AArch64 aggregate ABI (or refs/tinycc's chosen lowering) for passing/returning structs/unions by value, including nested structs, keeping behavior aligned with refs/tinycc first.","acceptance_criteria":"- scripts/run_mbtcc_ctest2.sh FILTER='basic_function3|basic_function4' MODE=strict passes\\n- scripts/run_mbtcc_ctest.sh FILTER='test5_struct_complex' MODE=strict passes","notes":"mbtcc ctest/ctest2 now pass MODE=strict for struct by-value param/return cases (basic_function3/4, test5_struct_complex). Behavior is aligned with refs/tinycc as exercised by the suite.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-14T04:13:56.451568+08:00","created_by":"agent","updated_at":"2026-01-14T07:12:48.72116+08:00","closed_at":"2026-01-14T07:12:48.72116+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-2k9.11","depends_on_id":"tinyccmbt-2k9","type":"parent-child","created_at":"2026-01-14T04:13:56.452229+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-2k9.12","title":"Codegen: 64-bit integer ops (long/long long) + correct unsigned semantics","description":"Current expression codegen largely uses 32-bit ops (gen_expr_int32) even when Sem types are long/long long. Some tests still pass due to small values, but bin_float.c requires 64-bit equality on long long bit patterns (double reinterpret).\\n\\nImplement type-driven integer codegen for 32/64-bit (add/sub/mul/div/mod, shifts, bitwise, comparisons) and correct signed/unsigned behavior, aligning first with refs/tinycc (tccgen.c gen_opi + arm64-gen.c integer ops).","acceptance_criteria":"- scripts/run_mbtcc_ctest.sh FILTER='bin_float' MODE=strict passes","notes":"mbtcc ctest now passes MODE=strict for bin_float.c (and full suite). Integer width + unsigned semantics are aligned to refs/tinycc as exercised by the suite.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-14T04:14:05.464726+08:00","created_by":"agent","updated_at":"2026-01-14T07:13:05.616327+08:00","closed_at":"2026-01-14T07:13:05.616327+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-2k9.12","depends_on_id":"tinyccmbt-2k9","type":"parent-child","created_at":"2026-01-14T04:14:05.465421+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-2k9.13","title":"VLA: restore SP at scope exit + support sizeof(VLA)","description":"Current VLA lowering allocates by subtracting from SP and only restores SP at the unified function return label. This diverges from refs/tinycc which restores SP when leaving the VLA's block scope (tccgen.c vla_leave/gen_vla_sp_restore). Also, sem currently rejects sizeof(variable length array) (src/sem.mbt: \"sizeof variable length array not supported yet\").\\n\\nFix should first align with refs/tinycc:\\n- Track per-scope VLA allocations and restore SP when exiting the scope (break/continue/goto/return paths included).\\n- Implement runtime sizeof(VLA) where required by C semantics / refs/tinycc behavior.","acceptance_criteria":"- Block-scoped VLA does not leak stack space across iterations (matches refs/tinycc behavior)\\n- sizeof(VLA) works for automatic VLAs where refs/tinycc supports it (no \"not supported yet\" diagnostic)","notes":"Start from refs/tinycc: tccgen.c vla_leave/vla_restore and arm64-gen.c gen_vla_sp_save/gen_vla_sp_restore/gen_vla_alloc.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-14T07:14:49.156643+08:00","created_by":"agent","updated_at":"2026-01-14T08:13:56.943538+08:00","closed_at":"2026-01-14T08:13:56.943538+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-2k9.13","depends_on_id":"tinyccmbt-2k9","type":"parent-child","created_at":"2026-01-14T07:14:59.330028+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-2k9.14","title":"VLA: support multi-dimensional VLAs (alloc/sizeof)","description":"Current VLA implementation only handles 1-D arrays where the element type has a compile-time size. Multi-dimensional VLAs (e.g. int a[n][m]) require runtime computation of the inner array size and total byte size; today type_size_align_or_error(elem_ty) fails once elem_ty is itself a VLA array.\\n\\nFix should first align with refs/tinycc:\\n- Mirror tccgen.c vpush_type_size behavior for VT_VLA (store computed byte size in a hidden local)\\n- Update arm64 codegen to allocate using the runtime byte size and to implement sizeof(VLA) for nested VLAs\\n- Keep scope-exit SP restore semantics consistent with refs (vla_leave/vla_restore).","acceptance_criteria":"- Can compile and run a test using multi-dimensional VLAs (e.g. int a[n][m])\\n- sizeof on multi-dimensional VLA matches refs/tinycc","notes":"Implemented multi-dimensional VLA sizing/alloc + sizeof runtime per refs/tinycc: type_size_align no longer errors on VLA, codegen computes nested VLA byte sizes recursively at runtime and stores total bytes in hidden slots; VLA alloc uses new size helper and supports nested VLAs. Added regression vla_multi.c under tests/mbtcc/ctest2_patches; ctest2 count now 67/67 (includes patch tests) passing in MODE=strict.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-14T08:13:11.116345+08:00","created_by":"agent","updated_at":"2026-01-14T09:25:48.3536+08:00","closed_at":"2026-01-14T09:25:48.353602+08:00","dependencies":[{"issue_id":"tinyccmbt-2k9.14","depends_on_id":"tinyccmbt-2k9","type":"parent-child","created_at":"2026-01-14T08:13:11.117006+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-2k9.15","title":"Codegen: implement goto/label + VLA restore","description":"Arm64 codegen currently treats Stmt::Goto / Stmt::Label as unsupported (falls into \"codegen: unsupported statement\"), so any refs/tinycc sources using goto/labels cannot be compiled. Once goto/label is supported, VLA stack pointer restoration must also follow refs/tinycc semantics (tccgen.c: vla_restore at labels/goto + leave_scope for jumps).\\n\\nFix should first align with refs/tinycc:\\n- Implement label definition + forward refs + goto lowering (chains / patching)\\n- Restore SP appropriately when jumping (vla_leave/vla_restore equivalent)\\n- Add a focused mbtcc test exercising goto across a scope with VLA.","acceptance_criteria":"- Can compile and run a small goto/label test\\n- Jumping out of a VLA scope restores SP (no stack leak / corruption)","notes":"Implemented goto/label codegen on arm64 AST, aligned with refs/tinycc vla_restore semantics: goto emits VLA SP restore (locorig) before branching; labels restore to the current scope VLA base and patch forward chains. Added per-function label address/chain tables and error handling for duplicates. Added deterministic VLA-leak regression test (tests/mbtcc/ctest2_patches/goto_vla.c) wired into run_mbtcc_ctest2.sh; suite now counts 66 tests all passing.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-14T08:13:35.556449+08:00","created_by":"agent","updated_at":"2026-01-14T09:09:57.420303+08:00","closed_at":"2026-01-14T09:09:57.420304+08:00","dependencies":[{"issue_id":"tinyccmbt-2k9.15","depends_on_id":"tinyccmbt-2k9","type":"parent-child","created_at":"2026-01-14T08:13:35.557057+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-2k9.16","title":"Mach-O: static/local symbols + relocs","description":"Compiling C that uses internal linkage (file-scope 'static' vars/functions) currently produces a Mach-O object that clang/ld refuses to link.\\n\\nRepro (macOS arm64):\\n- Create C file:\\n  int printf(const char*, ...);\\n  static int add1(int x) { return x + 1; }\\n  static int g = 41;\\n  int main() { printf(\"%d\\n\", add1(g)); return 0; }\\n- Compile: moon run --release src -- -c -o target/static_sym_test.o target/static_sym_test.c\\n- Link: clang -w target/static_sym_test.o -o target/static_sym_test.out\\n- ld fails (example): ld: relocation in '_main' is not supported ... r_extern=0 ...\\n\\nAlso observed a malformed object error (LINKEDIT string table beyond end) when patching a ctest2 file that introduced file-scope static symbols.\\n\\nFix should first align with refs/tinycc (arm64-gen.c + Mach-O emission):\\n- Proper local symbol table entries for internal linkage\\n- Correct relocation types/flags for local vs external symbols\\n- Ensure LINKEDIT/symtab/string tables have consistent sizes and offsets.","acceptance_criteria":"- The repro program links and runs via clang\\n- ctest/ctest2 still pass\\n- Can compile more refs/tinycc sources that use static symbols","notes":"Mach-O relocs now always use extern symbol numbers; local/static symbols no longer emit section-index relocs that ld rejects. Added regression static_internal.c under tests/mbtcc/ctest2_patches; ctest/ctest2 (incl. patch tests) pass MODE=strict, and the internal-linkage repro links/runs.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-14T08:46:28.741975+08:00","created_by":"agent","updated_at":"2026-01-14T09:39:35.552774+08:00","closed_at":"2026-01-14T09:39:35.552777+08:00","dependencies":[{"issue_id":"tinyccmbt-2k9.16","depends_on_id":"tinyccmbt-2k9","type":"parent-child","created_at":"2026-01-14T08:46:36.967697+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-2k9.2","title":"Codegen: unary ops + lvalues/pointers needed by mbtcc tests","description":"mbtcc tests hit many 'codegen: unsupported unary operator', 'unsupported lvalue', 'unsupported assignment lhs', and 'unsupported pointer expression' errors. Implement the missing unary operators and lvalue/pointer forms (address-of, deref, pre/post inc/dec as needed, compound lvalues like *(p+i), a[i], field lvalues) as close as possible to refs/tinycc (tccgen.c: indir/vstore/gaddrof, gen_opi, post/pre inc logic).","acceptance_criteria":"- unary1.c compiles and runs matching gcc\n- ptr.c/vec.c compile further (no 'unsupported unary/lvalue/pointer' errors)","notes":"mbtcc ctest now passes MODE=strict, including unary1.c, ptr.c, vec.c. Missing unary/lvalue/pointer codegen has been implemented aligned to refs/tinycc as exercised by the suite.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T21:43:59.893217+08:00","created_by":"agent","updated_at":"2026-01-14T07:13:25.638576+08:00","closed_at":"2026-01-14T07:13:25.638576+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-2k9.2","depends_on_id":"tinyccmbt-2k9","type":"parent-child","created_at":"2026-01-13T21:43:59.958633+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-2k9.3","title":"Codegen: missing binary operators used by mbtcc tests","description":"mbtcc tests frequently fail with 'codegen: unsupported binary operator for now' (comparisons, logical ops, shifts, etc). Implement the missing integer (and later float) binary ops following refs/tinycc's operator lowering in tccgen.c (gen_opi/gen_opf, comparison lowering, short-circuit \u0026\u0026/||).","acceptance_criteria":"- basic_control1..4 compile further (no 'unsupported binary operator')\n- bin_int.c output matches gcc","notes":"mbtcc ctest/ctest2 now pass MODE=strict for integer binary operators (bin_int.c, basic_control*, etc). Operator lowering matches refs/tinycc semantics as exercised by the suite.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T21:44:00.042512+08:00","created_by":"agent","updated_at":"2026-01-14T07:13:46.065681+08:00","closed_at":"2026-01-14T07:13:46.065681+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-2k9.3","depends_on_id":"tinyccmbt-2k9","type":"parent-child","created_at":"2026-01-13T21:44:00.108319+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-2k9.4","title":"Initializers: array/struct initializers beyond scalar","description":"mbtcc tests fail with 'only scalar initializers supported for now' and related unsupported initializer expressions (arr.c, arr_struct.c, plus many ctest2 cases). Implement array/struct initializer parsing+semantics and codegen emission close to refs/tinycc (tccgen.c: decl_initializer/init_putv, handling of nested braces/designators as needed for these tests).","acceptance_criteria":"- arr.c and arr_struct.c compile and run matching gcc","notes":"mbtcc ctest now passes MODE=strict (arr.c + arr_struct.c included). Implementation kept aligned with refs/tinycc initializer rules as exercised by the suite.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T21:44:00.191441+08:00","created_by":"agent","updated_at":"2026-01-14T07:10:49.637366+08:00","closed_at":"2026-01-14T07:10:49.637366+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-2k9.4","depends_on_id":"tinyccmbt-2k9","type":"parent-child","created_at":"2026-01-13T21:44:00.25704+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-2k9.5","title":"Sem/parser: fix anonymous tag redefinition (__anon_tag_1)","description":"mbtcc ctests typedef2.c and vec.c fail with 'redefinition of __anon_tag_1'. Fix anonymous struct/union tag naming/scope handling to match refs/tinycc behavior so each anonymous tag is unique in its scope and doesn't collide across separate decls.","acceptance_criteria":"- typedef2.c and vec.c no longer error on __anon_tag_1 redefinition","notes":"Root cause: parser stored typedef types with full struct/union/enum definitions (fields/items=Some(...)). When the typedef name was used later as a type specifier, the same definition was re-registered by sem (register_type_defs), triggering 'redefinition of __anon_tag_1' at use sites (e.g. typedef2.c, vec.c).\\n\\nFix: src/parser.mbt now stores a 'reference' form for typedefs via typedef_ref_type: structs/unions/enums drop their inline definitions (fields/items -\u003e None) while keeping the generated tag name. The original typedef declaration still carries the full definition so sem registers it once.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T21:44:00.340114+08:00","created_by":"agent","updated_at":"2026-01-13T22:36:17.178364+08:00","closed_at":"2026-01-13T22:36:17.178364+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-2k9.5","depends_on_id":"tinyccmbt-2k9","type":"parent-child","created_at":"2026-01-13T21:44:00.40678+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-2k9.6","title":"Types: incomplete arrays + sizeof rules used by mbtcc tests","description":"mbtcc tests hit 'incomplete array type' (trie.c) and 'sizeof incomplete array' errors in some ctest2 DSA cases. Align incomplete array typing and sizeof/decay rules with refs/tinycc's type system (tccgen.c / tcc.h).","acceptance_criteria":"- trie.c compiles further (no incomplete array type error)\n- failing sizeof-incomplete-array cases produce the same diagnostics/behavior as refs/tinycc","notes":"mbtcc ctest now passes MODE=strict (trie.c and sizeof.c included). Incomplete array handling and sizeof rules are aligned to refs/tinycc as exercised by the suite.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T21:44:00.492833+08:00","created_by":"agent","updated_at":"2026-01-14T07:11:10.721969+08:00","closed_at":"2026-01-14T07:11:10.721969+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-2k9.6","depends_on_id":"tinyccmbt-2k9","type":"parent-child","created_at":"2026-01-13T21:44:00.558764+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-2k9.7","title":"Codegen: float/double support (literals, locals, ops, calls)","description":"mbtcc ctest/ctest2 still fail heavily on float/double: float/double literals/initializers, local storage, loads/stores, arithmetic (+-*/ unary -), comparisons, casts, and calling convention (sqrt/sqrtf and printf varargs with %f/%lf).\\n\\nImplementation must first try to align with refs/tinycc behavior (tccgen.c gen_opf/expr typing + arm64-gen.c FP ops/ABI). Avoid ad-hoc semantics changes.","acceptance_criteria":"- scripts/run_mbtcc_ctest.sh FILTER='arr|arr_struct|bin_float|typedef2|struct3|vec' MODE=strict passes\\n- scripts/run_mbtcc_ctest2.sh FILTER='basic_float_arith|complex_arith' MODE=strict passes","notes":"mbtcc ctest/ctest2 float-heavy tests now pass MODE=strict (bin_float.c, basic_float_arith*, complex_arith*). Kept behavior aligned with refs/tinycc (arm64 ABI + FP ops) as exercised by the suite.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-14T04:13:13.338945+08:00","created_by":"agent","updated_at":"2026-01-14T07:11:24.133608+08:00","closed_at":"2026-01-14T07:11:24.133608+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-2k9.7","depends_on_id":"tinyccmbt-2k9","type":"parent-child","created_at":"2026-01-14T04:13:13.33981+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-2k9.8","title":"Codegen: globals beyond int32 (arrays/pointers/data relocs)","description":"Current object emitter only supports 32-bit int globals and constant int initializers; mbtcc ctest fails for global arrays/pointers (e.g. dsu.c, hash_table.c).\\n\\nImplement .data/.bss layout and relocations for non-int globals (arrays, pointers, structs) as close as possible to refs/tinycc (tccgen.c decl_initializer/init_putv + arm64-gen.c section/reloc handling).","acceptance_criteria":"- scripts/run_mbtcc_ctest.sh FILTER='dsu|hash_table' MODE=strict passes","notes":"mbtcc ctest now passes MODE=strict for globals-heavy cases (dsu.c, hash_table.c). Global data/relocs are aligned with refs/tinycc as exercised by the suite.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-14T04:13:23.522505+08:00","created_by":"agent","updated_at":"2026-01-14T07:11:43.182396+08:00","closed_at":"2026-01-14T07:11:43.182396+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-2k9.8","depends_on_id":"tinyccmbt-2k9","type":"parent-child","created_at":"2026-01-14T04:13:23.523139+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-2k9.9","title":"Parser/sem/codegen: array size expressions + VLAs","description":"Parser currently only accepts IntLit in array declarators; mbtcc ctest2 uses sizes like 'n+1' and other expressions, plus VLAs (e.g. dsa_dp_fibonacci.c, dsa_dp_lis.c, dsa_merge_sort.c).\\n\\nImplement array-size parsing for constant expressions, and VLA semantics/codegen (dynamic stack alloc, sizeof/decay) in a way that first matches refs/tinycc behavior. If refs/tinycc rejects a case, mirror its diagnostic rather than inventing new rules.","acceptance_criteria":"- scripts/run_mbtcc_ctest2.sh FILTER='dsa_dp_fibonacci|dsa_dp_lis|dsa_merge_sort' MODE=strict passes","notes":"Implemented array size expressions + VLAs close to refs/tinycc:\\n- Parser: CType::Array carries optional size_expr (src/parser.mbt, src/ast.mbt)\\n- Sem: resolves constant size_expr to size; non-constant sizes become VLA for automatic locals; rejects init on VLA (src/sem.mbt)\\n- Codegen (arm64): allocates VLA via dynamic SP decrement (16-byte aligned) and stores base pointer into a fixed local slot; restores SP to frame base at unified return label (src/codegen_arm64_ast.mbt)\\n\\nAcceptance: scripts/run_mbtcc_ctest2.sh FILTER='dsa_dp_fibonacci|dsa_dp_lis|dsa_merge_sort' MODE=strict passes.\\n\\nKnown gaps vs refs/tinycc to track separately: VLA lifetime restoration at block-scope exit and sizeof(VLA) runtime.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-14T04:13:35.050679+08:00","created_by":"agent","updated_at":"2026-01-14T07:12:11.816255+08:00","closed_at":"2026-01-14T07:12:11.816255+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-2k9.9","depends_on_id":"tinyccmbt-2k9","type":"parent-child","created_at":"2026-01-14T04:13:35.051372+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-3","title":"MoonBit parser+types+sem","description":"Implement C parser, types, and semantic analysis in MoonBit (AST, symbol tables, type checking) based on refs/tinycc/tccgen.c.\n\nImplementation must stay as close as possible to refs/tinycc.","notes":"Parser/types/sem implementation largely complete and aligned with refs/tinycc/tccgen.c: statements+decls, type sizes/ranks + usual arithmetic conversions, storage classes, initializers (designators/array sizing), const-expr (incl sizeof), integer literal typing by base/value, compatible global redecls, typeof/__attribute__ parsing+typing, builtin semantics (offsetof/types_compatible_p/va_arg/choose_expr/expect/constant_p + atomic/builtin typing), and implicit function decls on call sites; wbtests cover these behaviors.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T15:34:11.562419+08:00","created_by":"agent","updated_at":"2026-01-13T20:05:58.036371+08:00","closed_at":"2026-01-13T20:05:58.036371+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-3","depends_on_id":"tinyccmbt-1","type":"parent-child","created_at":"2026-01-10T01:45:51.823653+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-3.1","title":"Expand parser/sem for statements and declarations","description":"Add control-flow statements (if/while/for/switch), richer declarators (arrays, function pointers, structs/unions/enums/typedef), and improve semantic analysis (forward decls, pointer ops).\n\nImplementation must stay as close as possible to refs/tinycc.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T18:49:56.906427+08:00","created_by":"agent","updated_at":"2026-01-10T02:44:27.074987+08:00","closed_at":"2026-01-10T02:44:27.074987+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-3.1","depends_on_id":"tinyccmbt-1","type":"parent-child","created_at":"2026-01-10T01:45:51.241424+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-3.2","title":"Parser/sem: type sizes, conversions, storage classes","description":"Implement type sizes/ranks, usual arithmetic conversions, and storage-class semantics (extern/static/register/auto) consistent with refs/tinycc/tccgen.c.\\n\\nImplementation must stay as close as possible to refs/tinycc.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T03:39:45.642693+08:00","created_by":"agent","updated_at":"2026-01-11T02:29:21.531021+08:00","closed_at":"2026-01-11T02:29:21.531021+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-3.2","depends_on_id":"tinyccmbt-3","type":"parent-child","created_at":"2026-01-10T03:39:45.643577+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-3.3","title":"Initializer semantics: const expr/designators/array sizing","description":"Implement constant-expression evaluation for bitfield widths and designator indices, infer array sizes from initializer lists, and handle aggregate initializer rules per refs/tinycc/tccgen.c.\\n\\nImplementation must stay as close as possible to refs/tinycc.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T03:39:55.791425+08:00","created_by":"agent","updated_at":"2026-01-11T02:44:26.954721+08:00","closed_at":"2026-01-11T02:44:26.954721+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-3.3","depends_on_id":"tinyccmbt-3","type":"parent-child","created_at":"2026-01-10T03:39:55.792071+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-3.4","title":"Const expr: support sizeof in constant expressions","description":"Allow sizeof in constant-expression evaluation for enums, bitfield widths, and designator indices (eval_const_expr_value), aligned with refs/tinycc/tccgen.c. Keep implementation as close as possible to refs/tinycc.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T02:49:09.447703+08:00","created_by":"agent","updated_at":"2026-01-11T02:57:13.534937+08:00","closed_at":"2026-01-11T02:57:13.534937+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-3.4","depends_on_id":"tinyccmbt-3","type":"parent-child","created_at":"2026-01-11T02:49:09.448592+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-3.5","title":"Sem: integer literal type selection by value/base","description":"Implement C integer literal typing based on value and base (decimal vs hex/octal), matching refs/tinycc/tccgen.c constant handling. Current sem picks type only from suffix.","notes":"Implemented integer literal type selection by base/value (decimal vs hex/octal) with manual UInt64 parsing to handle 0b/0x prefixes; added tests for type selection.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T02:11:30.008535+08:00","created_by":"agent","updated_at":"2026-01-12T02:44:43.778157+08:00","closed_at":"2026-01-12T02:44:43.778159+08:00","dependencies":[{"issue_id":"tinyccmbt-3.5","depends_on_id":"tinyccmbt-3","type":"parent-child","created_at":"2026-01-12T02:11:30.009142+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-3.6","title":"Sem: allow compatible global redeclarations","description":"Relax global variable redeclaration checks to allow compatible types (including incomplete/complete arrays) like refs/tinycc; update type compatibility for arrays with unknown size.","notes":"Allowed compatible global redeclarations (including incomplete array completion), updated array type compatibility, and added tests for compatible/incompatible redecls.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T02:11:39.230212+08:00","created_by":"agent","updated_at":"2026-01-12T02:44:59.475715+08:00","closed_at":"2026-01-12T02:44:59.475716+08:00","dependencies":[{"issue_id":"tinyccmbt-3.6","depends_on_id":"tinyccmbt-3","type":"parent-child","created_at":"2026-01-12T02:11:39.230805+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-3.7","title":"Parser/sem: typeof and __attribute__ support","description":"Implement GNU C typeof expressions and __attribute__ parsing/typing per refs/tinycc/tccgen.c and tccpp.c. Add AST nodes, parser handling, and semantic checks; keep behavior as close as possible to refs/tinycc.","notes":"Added call-convention handling for function types/signatures (normalize/merge, apply to declarators/params/fields), parse __attribute__ after struct closing brace, clamp regparm to 1..3, and added tests for trailing packed struct + callconv compat; extended CType::Function with call_conv and FuncSig checks. Parse __attribute__ inside pointer declarators (before/after '*') and after labels; added tests for label attributes and pointer call-conv parsing.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T18:42:49.402173+08:00","created_by":"agent","updated_at":"2026-01-13T02:00:35.156332+08:00","closed_at":"2026-01-13T02:00:35.156332+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-3.7","depends_on_id":"tinyccmbt-3","type":"parent-child","created_at":"2026-01-12T18:42:49.403068+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-3.8","title":"Parser/sem: implement remaining tinycc builtins","description":"Implement remaining builtin identifiers and semantics used by refs/tinycc/tccgen.c (e.g., __builtin_frame_address/__builtin_return_address, __builtin_unreachable (codegen), __builtin_va_start/__builtin_va_arg (proper typing + codegen hooks), __atomic_* builtins parsing/type rules), keeping behavior as close as possible to refs/tinycc.","notes":"Implemented __builtin_offsetof (parsing + constant evaluation against record layout), added sem typing for common libc builtins (mem*/str*/alloc/free) so refs/tinycc builtins tests type-check, and added __builtin_frame_address/__builtin_return_address typing + level checks. Added wbtests for offsetof/builtins.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T17:59:40.441259+08:00","created_by":"agent","updated_at":"2026-01-13T18:16:58.541123+08:00","closed_at":"2026-01-13T18:16:58.541123+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-3.8","depends_on_id":"tinyccmbt-3","type":"parent-child","created_at":"2026-01-13T17:59:40.442067+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-3.9","title":"Sem: atomic builtins + remaining builtin semantics","description":"Implement remaining builtin semantics used by refs/tinycc/tccgen.c that are still missing: __atomic_* builtins parsing/type rules, stronger __builtin_va_start/__builtin_va_arg checks (va_list typing), and any other __builtin_* forms needed by refs/tinycc/tests/tests2. Keep behavior as close as possible to refs/tinycc.","notes":"Implemented __atomic_* builtin typing/argument checks using the same templates as refs/tinycc/tccgen.c: __atomic_store/load/exchange/compare_exchange and fetch/add/sub/or/xor/and/nand (+ *_fetch variants). Also tightened __builtin_va_start to require the first argument be a local variable (close to refs/tinycc). Added wbtests for atomic builtins.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T18:16:58.11522+08:00","created_by":"agent","updated_at":"2026-01-13T18:26:47.480343+08:00","closed_at":"2026-01-13T18:26:47.480343+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-3.9","depends_on_id":"tinyccmbt-3","type":"parent-child","created_at":"2026-01-13T18:16:58.11595+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-4","title":"MoonBit arm64 codegen","description":"Implement arm64 code generation in MoonBit (instruction selection, register allocation), based on refs/tinycc/arm64-gen.c.\n\nImplementation must stay as close as possible to refs/tinycc.","notes":"AST→arm64 Mach-O codegen implemented (close to refs/tinycc/arm64-gen.c): stack frames/locals, int expressions, direct calls (args \u003c=8), global int load/store, control flow (if/while/do-while/for + break/continue) via b.cond patching + jump chains, __TEXT,__cstring emission for string literals, and basic pointer/address/deref/scalar load/store + pointer arithmetic.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T15:34:17.064559+08:00","created_by":"agent","updated_at":"2026-01-13T20:46:24.46007+08:00","closed_at":"2026-01-13T20:46:24.46007+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-4","depends_on_id":"tinyccmbt-1","type":"parent-child","created_at":"2026-01-10T01:45:51.75899+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-4.1","title":"Codegen: locals + stack frame","description":"Implement function stack frame setup, local variable allocation, and load/store lowering in arm64 codegen, staying close to refs/tinycc (tccgen.c + arm64-gen.c).\\n\\nImplementation must stay as close as possible to refs/tinycc.","notes":"Implemented AST→arm64 codegen stack frames and local allocation: two-pass layout to assign FP-relative offsets, 16-byte stack alignment, param spill to locals (x0-x7), local DeclStmt init store/load, and return jump-chain patching via gsym/gjmp (tinycc-like). Added codegen driver in src/codegen_arm64_ast.mbt and updated tests; validated by compiling+linking a program with a local var.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T18:46:40.254133+08:00","created_by":"agent","updated_at":"2026-01-13T19:15:27.009416+08:00","closed_at":"2026-01-13T19:15:27.009416+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-4.1","depends_on_id":"tinyccmbt-4","type":"parent-child","created_at":"2026-01-13T18:46:40.254763+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-4.2","title":"Codegen: expr/return/calls (int subset)","description":"Extend AST→arm64 codegen to handle integer expressions (literals, identifiers, unary/binary ops, assignments), return statements, and simple function calls, staying close to refs/tinycc (tccgen.c + arm64-gen.c).\\n\\nImplementation must stay as close as possible to refs/tinycc.","notes":"Extended codegen to cover int subset expressions/returns/calls: gen_expr_int32 supports literals/idents, unary +/-/~/!, binary + - * / % \u0026 | ^ == != \u003c \u003c= \u003e \u003e= , assignment to ident (local/global), comma, constant shift immediates; direct calls to identifier with up to 8 int args/params; emits call relocs and global load/store via adrp+add+ldr/str. main emitted first in .text; updated codegen wbtests and validated with clang link+run.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T18:46:40.33194+08:00","created_by":"agent","updated_at":"2026-01-13T19:15:59.61807+08:00","closed_at":"2026-01-13T19:15:59.61807+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-4.2","depends_on_id":"tinyccmbt-4","type":"parent-child","created_at":"2026-01-13T18:46:40.332553+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-4.3","title":"Codegen: if/while/for control flow","description":"Add control-flow codegen (if/else, while, for, break/continue) using arm64 branch/label patching, staying close to refs/tinycc (tccgen.c + arm64-gen.c).\\n\\nImplementation must stay as close as possible to refs/tinycc.","notes":"Implemented control-flow codegen in AST→arm64 backend: if/else, while, do-while, for (with for-scope matching sem), and break/continue using unconditional jump chains patched via gsym_addr + conditional branches via b.cond imm19 patching (ARM64_COND_EQ/NE). Added wbtests that assert emitted .text contains conditional/unconditional branch encodings.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T18:46:40.408983+08:00","created_by":"agent","updated_at":"2026-01-13T19:41:11.812508+08:00","closed_at":"2026-01-13T19:41:11.812508+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-4.3","depends_on_id":"tinyccmbt-4","type":"parent-child","created_at":"2026-01-13T18:46:40.409649+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-4.4","title":"Codegen: strings + extern calls","description":"Implement string literal emission (e.g., __TEXT,__cstring / .cstring section) and calling extern functions like printf with correct argument materialization, staying close to refs/tinycc (tccgen.c + tccmacho.c + arm64-gen.c).\\n\\nImplementation must stay as close as possible to refs/tinycc.","notes":"Implemented string literal emission as Mach-O __TEXT,__cstring via a .cstring section (S_CSTRING_LITERALS, align=1) and codegen materializes string addresses with ADRP+ADD relocations; added wbtest for extern puts(\"hi\") verifying __cstring bytes and reloc count.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T19:17:19.982253+08:00","created_by":"agent","updated_at":"2026-01-13T20:03:41.676481+08:00","closed_at":"2026-01-13T20:03:41.676481+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-4.4","depends_on_id":"tinyccmbt-4","type":"parent-child","created_at":"2026-01-13T19:17:19.982925+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-4.5","title":"Codegen: pointers/address/deref","description":"Add codegen for address-of, dereference, pointer arithmetic, and loads/stores for non-int types, staying close to refs/tinycc (tccgen.c + arm64-gen.c).\\n\\nImplementation must stay as close as possible to refs/tinycc.","notes":"Implemented pointer/scalar codegen in AST→arm64 emitter (close to refs/tinycc arm64-gen.c): unary \u0026 and * via lvalue address materialization, scalar loads/stores for 1/2/4/8-byte types using arm64_ldrx/strx (locals and *p assignments), pointer +/- int with element-size scaling, basic index addressing, pointer arg passing (uses x regs when needed), and pointer ==/!= comparisons; added wbtest exercising addr/deref/compare.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T19:17:20.059187+08:00","created_by":"agent","updated_at":"2026-01-13T20:45:37.895438+08:00","closed_at":"2026-01-13T20:45:37.895438+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-4.5","depends_on_id":"tinyccmbt-4","type":"parent-child","created_at":"2026-01-13T19:17:20.059816+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-5","title":"MoonBit Mach-O writer","description":"Implement Mach-O writer for arm64 object files in MoonBit, based on refs/tinycc/tccmacho.c.\n\nImplementation must stay as close as possible to refs/tinycc.","notes":"Mach-O object writer encodes segments/sections, symtab+strtab (leading space per refs/tccmacho.c), section relocations (ARM64_RELOC_* mapping incl GOT/PAGE21/PAGEOFF12/BRANCH26), and includes LC_BUILD_VERSION + LC_SOURCE_VERSION like refs/tccmacho.c; wbtests cover header, reloc count, kind mapping, and GOT reloc encoding.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T15:34:20.735493+08:00","created_by":"agent","updated_at":"2026-01-13T18:36:30.123219+08:00","closed_at":"2026-01-13T18:36:30.123219+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-5","depends_on_id":"tinyccmbt-4","type":"blocks","created_at":"2026-01-09T17:12:10.453809+08:00","created_by":"import"},{"issue_id":"tinyccmbt-5","depends_on_id":"tinyccmbt-1","type":"parent-child","created_at":"2026-01-10T01:45:51.695078+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-6","title":"MoonBit CLI/build integration","description":"Implement CLI flags and build integration for compiler pipeline (preprocess/compile to .o).\n\nImplementation must stay as close as possible to refs/tinycc.","notes":"CLI/build integration completed: manual argv parsing (closer to refs/tinycc) for -c/-o/-I/-isystem and multiple inputs; end-to-end preprocess→parse→sem→codegen emits Mach-O arm64 .o via moonbitlang/x/fs; diagnostics printed with file/line/col and nonzero exit via moonbitlang/x/sys.exit.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T15:34:25.634198+08:00","created_by":"agent","updated_at":"2026-01-13T21:11:26.132759+08:00","closed_at":"2026-01-13T21:11:26.132759+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-6","depends_on_id":"tinyccmbt-1","type":"parent-child","created_at":"2026-01-10T01:45:51.630899+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-6.1","title":"CLI: implement compile-to-.o pipeline","description":"Implement end-to-end -c compilation pipeline in CLI: read input (prefer moonbitlang/x/fs), preprocess, parse, sem-check, codegen to Mach-O .o bytes, and write to -o path. Match refs/tinycc main.c + tccpp.c + tccgen.c behavior as closely as possible (flags, defaults, errors).\\n\\nImplementation must stay as close as possible to refs/tinycc.","notes":"CLI now runs full -c pipeline end-to-end: read file via moonbitlang/x/fs, preprocess with -I/-isystem include paths, parse, sem-check, codegen to arm64 Mach-O .o bytes, and write output (default derives input basename + .o; -o only allowed with single input). Also fixed codegen to allow compiling objects without a main() definition (main is no longer required).","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T20:47:59.446265+08:00","created_by":"agent","updated_at":"2026-01-13T21:11:25.935408+08:00","closed_at":"2026-01-13T21:11:25.935408+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-6.1","depends_on_id":"tinyccmbt-6","type":"parent-child","created_at":"2026-01-13T20:47:59.447451+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-6.2","title":"CLI: diagnostics + exit codes + multiple inputs","description":"Bring CLI behavior closer to refs/tinycc: proper error reporting (file/line), nonzero exit codes on diagnostics, support multiple input files (compile separately), and normalize include paths handling (-I, -isystem if applicable).\\n\\nImplementation must stay as close as possible to refs/tinycc.","notes":"CLI behavior closer to refs/tinycc: supports multiple input files for -c compilation, prints all diagnostics as path:line:col: message, and exits nonzero on errors using moonbitlang/x/sys.exit. Unknown options are rejected; -o with multiple inputs errors. Added parser support for -isystem as include path.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T20:47:59.539039+08:00","created_by":"agent","updated_at":"2026-01-13T21:11:26.000929+08:00","closed_at":"2026-01-13T21:11:26.000929+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-6.2","depends_on_id":"tinyccmbt-6","type":"parent-child","created_at":"2026-01-13T20:47:59.540038+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-6ee","title":"Preprocessor macro recursion and whitespace handling","description":"Add recursion guard/disabled set for macro expansion, track whitespace to distinguish function-like macro invocation, and refine argument expansion order per C rules.\n\nImplementation must stay as close as possible to refs/tinycc.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T18:05:43.042885+08:00","created_by":"agent","updated_at":"2026-01-10T01:40:41.725762+08:00","closed_at":"2026-01-09T18:26:45.257308+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-6ee","depends_on_id":"tinyccmbt-1","type":"parent-child","created_at":"2026-01-10T01:45:51.370266+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-7","title":"Use clap.mbt for cli args; See: https://github.com/TheWaWaR/clap.mbt","description":"Use clap.mbt for CLI argument parsing; see https://github.com/TheWaWaR/clap.mbt.\n\nImplementation must stay as close as possible to refs/tinycc.","notes":"Switched CLI argument parsing to TheWaWaR/clap (keep behavior close to tinycc): clap parses -c/-o and positional input; -I include paths (including -I\u003cpath\u003e) are normalized/collected and then passed into preprocessor include search. Unknown flags remain ignored for now. Added wbtests for CLI parsing.","status":"closed","priority":2,"issue_type":"task","assignee":"agent","created_at":"2026-01-09T16:48:40.290709+08:00","created_by":"agent","updated_at":"2026-01-13T16:51:14.638348+08:00","closed_at":"2026-01-13T16:51:14.638348+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-7","depends_on_id":"tinyccmbt-1","type":"parent-child","created_at":"2026-01-10T01:45:51.565633+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-8","title":"Preprocessor directives and macro expansion","description":"Implement #define/#undef macros, conditional compilation (#if/#ifdef/#ifndef/#elif/#endif), and #include handling, using lexer line_start for directive detection. Base behavior on refs/tinycc/tccpp.c.\n\nImplementation must stay as close as possible to refs/tinycc.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T17:02:10.244182+08:00","created_by":"agent","updated_at":"2026-01-10T01:40:41.597333+08:00","closed_at":"2026-01-09T17:49:52.625255+08:00","dependencies":[{"issue_id":"tinyccmbt-8","depends_on_id":"tinyccmbt-1","type":"parent-child","created_at":"2026-01-10T01:45:51.499865+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-9","title":"Preprocessor: function-like macros and #if expression eval","description":"Extend macro expansion with function-like macros, variadics, token pasting/stringizing, and evaluate #if expressions (basic operators, arithmetic, defined). Also implement include search paths beyond current file directory.\n\nImplementation must stay as close as possible to refs/tinycc.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T17:50:00.078519+08:00","created_by":"agent","updated_at":"2026-01-10T01:40:41.660997+08:00","closed_at":"2026-01-09T18:05:30.711626+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-9","depends_on_id":"tinyccmbt-1","type":"parent-child","created_at":"2026-01-10T01:45:51.434746+08:00","created_by":"agent"}]}
{"id":"tinyccmbt-980","title":"arm64: implement arm64_sym and relocation hooks","description":"arm64_sym emits ADRP/LD GOT reloc entries into Arm64Emitter.relocs; added Section/Reloc scaffolding with section_from_emitter to carry code+relocs. Still need real object writer (Mach-O/ELF) and symbol/reloc tables per refs/tinycc.\n\nImplementation must stay as close as possible to refs/tinycc.","notes":"Mach-O writer now emits symtab/strtab and relocation entries for arm64, including GOT load relocs from arm64_sym. Added wbtest asserting ARM64_RELOC_GOT_LOAD_PAGE21/PAGEOFF12 relocation encoding is extern with correct symbol index.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T00:14:55.685349+08:00","created_by":"agent","updated_at":"2026-01-13T18:36:29.515274+08:00","closed_at":"2026-01-13T18:36:29.515274+08:00","close_reason":"Closed"}
{"id":"tinyccmbt-enf","title":"Clean up remaining unused warnings","notes":"moon check/build still report 34 warnings (unused arm64 helpers, Mach-O layout struct/fields, unused diag helpers, unreachable add_error fallback). Align with refs/tinycc before removing/suppressing.","status":"open","priority":3,"issue_type":"task","owner":"hackwaly@qq.com","created_at":"2026-01-14T13:32:08.052075+08:00","created_by":"Wen Yuxiang","updated_at":"2026-01-14T13:32:08.052075+08:00"}
{"id":"tinyccmbt-oix","title":"Parser: support K\u0026R old-style function definitions","description":"Handle K\u0026R-style function definitions with identifier parameter lists plus trailing parameter declarations (e.g., int f(a,b) int a; char b; { ... }), mirroring refs/tinycc tccgen.c. Ensure old-style parameter default promotions are applied where required.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T16:12:18.732042+08:00","created_by":"agent","updated_at":"2026-01-12T16:26:32.098125+08:00","closed_at":"2026-01-12T16:26:32.098125+08:00","close_reason":"Closed"}
{"id":"tinyccmbt-z96","title":"Preprocessor include path configuration","description":"Wire include path list (-I) into preprocessor, using add_include_path and search order for angle/quote includes.\n\nImplementation must stay as close as possible to refs/tinycc.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T18:26:57.403146+08:00","created_by":"agent","updated_at":"2026-01-11T03:26:23.291996+08:00","closed_at":"2026-01-11T03:26:23.291996+08:00","close_reason":"Closed","dependencies":[{"issue_id":"tinyccmbt-z96","depends_on_id":"tinyccmbt-1","type":"parent-child","created_at":"2026-01-10T01:45:51.30597+08:00","created_by":"agent"}]}
